name: Supabase CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # Preview database for PRs
  preview-database:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      api-url: ${{ steps.supabase-branch.outputs.api_url }}
      anon-key: ${{ steps.supabase-branch.outputs.anon_key }}
      service-role-key: ${{ steps.supabase-branch.outputs.service_role_key }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Supabase preview branch
        id: supabase-branch
        uses: 0xbigboss/supabase-branch-gh-action@v1
        with:
          supabase-access-token: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          supabase-project-id: ${{ secrets.VITE_SUPABASE_PROJECT_ID }}
          wait-for-migrations: true
          timeout: 120

      - name: Comment PR with preview database info
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## üóÑÔ∏è Supabase Preview Database
            
            A preview database has been created for this PR!
            
            | Property | Value |
            |----------|-------|
            | üîó API URL | \`${{ steps.supabase-branch.outputs.api_url }}\` |
            | üìä GraphQL | \`${{ steps.supabase-branch.outputs.graphql_url }}\` |
            | üîë Database | \`${{ steps.supabase-branch.outputs.db_host }}\` |
            
            **Note:** Credentials are available as workflow outputs for testing.
            
            This preview database will be automatically cleaned up when the PR is closed.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Build and deploy
  build-and-deploy:
    runs-on: ubuntu-latest
    needs: [preview-database]
    if: always() && (needs.preview-database.result == 'success' || needs.preview-database.result == 'skipped')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Build application
        env:
          # Use preview database for PRs, production for main
          VITE_SUPABASE_URL: ${{ github.event_name == 'pull_request' && needs.preview-database.outputs.api-url || secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ github.event_name == 'pull_request' && needs.preview-database.outputs.anon-key || secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}
          VITE_SUPABASE_PROJECT_ID: ${{ secrets.VITE_SUPABASE_PROJECT_ID }}
        run: npm run build

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase project
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "Warning: SUPABASE_ACCESS_TOKEN not set, skipping Supabase deployment"
            exit 0
          fi
          supabase link --project-ref ${{ secrets.VITE_SUPABASE_PROJECT_ID }}

      - name: Deploy database migrations
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && secrets.SUPABASE_ACCESS_TOKEN != ''
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase db push || echo "No pending migrations"

      - name: Deploy Supabase Functions
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && secrets.SUPABASE_ACCESS_TOKEN != ''
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          VERCEL_AI_GATEWAY_KEY: ${{ secrets.VERCEL_AI_GATEWAY_KEY }}
        run: |
          if [ -d "supabase/functions" ]; then
            # Set secrets for edge functions
            if [ -n "$VERCEL_AI_GATEWAY_KEY" ]; then
              supabase secrets set VERCEL_AI_GATEWAY_KEY="$VERCEL_AI_GATEWAY_KEY" --project-ref ${{ secrets.VITE_SUPABASE_PROJECT_ID }} || echo "Warning: Failed to set VERCEL_AI_GATEWAY_KEY"
            fi
            
            # Deploy all functions
            for func in supabase/functions/*/; do
              if [ -d "$func" ]; then
                func_name=$(basename "$func")
                echo "Deploying function: $func_name"
                supabase functions deploy "$func_name" --project-ref ${{ secrets.VITE_SUPABASE_PROJECT_ID }} || echo "Failed to deploy $func_name, continuing..."
              fi
            done
          else
            echo "No functions directory found, skipping..."
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || 'main' }}
          path: dist/
          retention-days: 7
